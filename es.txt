// Floating widget to toggle all map layers ON/OFF
// Wait for the DOM and the Esri MapView to be available before adding the widget
function addFloatingLayerWidget() {
  // Only add once
  if (document.getElementById("__layerToggleWidget")) return;

  const widgetContainer = document.createElement("div");
  widgetContainer.id = "__layerToggleWidget";
  widgetContainer.style.position = "absolute";
  widgetContainer.style.top = "20px";
  widgetContainer.style.right = "20px";
  widgetContainer.style.zIndex = "9999";
  widgetContainer.style.background = "white";
  widgetContainer.style.border = "1px solid #ccc";
  widgetContainer.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
  widgetContainer.style.padding = "12px 20px";
  widgetContainer.style.borderRadius = "8px";
  widgetContainer.style.display = "flex";
  widgetContainer.style.gap = "12px";
  widgetContainer.style.alignItems = "center";
  widgetContainer.style.pointerEvents = "auto";

  // ON Button
  const onBtn = document.createElement("button");
  onBtn.textContent = "ON";
  onBtn.style.padding = "6px 16px";
  onBtn.style.background = "#388e3c";
  onBtn.style.color = "white";
  onBtn.style.border = "none";
  onBtn.style.borderRadius = "4px";
  onBtn.style.cursor = "pointer";
  onBtn.onclick = () => {
    if (window.view && window.view.map && window.view.map.layers) {
      window.view.map.layers.forEach(layer => {
        layer.visible = true;
        layer.listMode = "show";
      });
    }
  };

  // OFF Button
  const offBtn = document.createElement("button");
  offBtn.textContent = "OFF";
  offBtn.style.padding = "6px 16px";
  offBtn.style.background = "#c62828";
  offBtn.style.color = "white";
  offBtn.style.border = "none";
  offBtn.style.borderRadius = "4px";
  offBtn.style.cursor = "pointer";
  offBtn.onclick = () => {
    if (window.view && window.view.map && window.view.map.layers) {
      window.view.map.layers.forEach(layer => {
        layer.visible = false;
        layer.listMode = "hide";
      });
    }
  };

  widgetContainer.appendChild(onBtn);
  widgetContainer.appendChild(offBtn);

  // Try to add the widget as an overlay inside the ESRI #viewDiv or MapView container
  let parent = null;
  // Try Esri's common id
  if (document.getElementById("viewDiv")) {
    parent = document.getElementById("viewDiv");
    parent.style.position = "relative";
  } else if (window.view && window.view.container && window.view.container instanceof HTMLElement) {
    parent = window.view.container;
    parent.style.position = "relative";
  } else {
    // fallback to body
    parent = document.body;
  }
  parent.appendChild(widgetContainer);
}

// Listen for window.view, or DOMLoaded, then call addFloatingLayerWidget
function tryInitFloatingWidget() {
  if (window.view && window.view.ready) {
    // If Esri View is ready, add widget
    addFloatingLayerWidget();
  } else if (window.view && typeof window.view.when === "function") {
    // wait for view to be ready
    window.view.when(addFloatingLayerWidget);
  } else {
    // Fallback, wait a bit and retry
    setTimeout(tryInitFloatingWidget, 500);
  }
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", tryInitFloatingWidget);
} else {
  tryInitFloatingWidget();
}

