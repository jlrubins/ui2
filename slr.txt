<?php

require_once __DIR__ . '/include.php';
require_once('Helpers/classSecurity.php');
require_once('Helpers/class.CORE.leaksUser.php');

use \LeaksApp\CoreHandler;
use \LeaksApp\General;

// Set memory limit and error reporting
ini_set('memory_limit', '1G');
error_reporting(E_ERROR | E_PARSE);
set_time_limit(240000); // allow lots of time in case of massive query

// Set download cookie
setCookie("downloadStarted", 1, time() + 20, '/', "", false, false);

// Validate user session
$username = filter_var($_SESSION['XOC']['USERNAME'] ?? '', FILTER_SANITIZE_STRING);
if (empty($username)) {
    die('Unauthorized access');
}

// Get user locations with proper validation
$locs = General::instance()->getUserLocations($username);
$locations = [];
$strWhere = '';

// Validate and sanitize locations
if (!empty($locs) && is_array($locs)) {
    // Ensure all location IDs are integers
    foreach ($locs as $loc) {
        if (is_numeric($loc)) {
            $locations[] = (int)$loc;
        }
    }
    
    if (!empty($locations)) {
        // Create a safe IN clause using implode with integers
        $locPlaceholders = str_repeat('?,', count($locations) - 1) . '?';
        $strWhere = " AND l.locationId IN ($locPlaceholders)";
    }
}

// Set show last days parameter with default value
$showLast = 20;
if (isset($_GET['days']) && is_numeric($_GET['days'])) {
    $showLast = (int)$_GET['days'];
    // Limit the range to prevent abuse
    $showLast = max(1, min($showLast, 365));
}

// Prepare the main query with parameterized statements to prevent SQL injection
$query = "SELECT 
    a.acct, 
    a.leakid lid, 
    a.address_line1 address, 
    l.DateTimeofRecord, 
    a.city,
    l.uV_mLevel, 
    a.repair_code, 
    a.repair_date,
    a.repair_time,
    a.tech, 
    a.wt_job, 
    a.ordid,
    a.jobid,
    l.Status,
    a.job_status,
    a.node_name,
    a.mgmt_area,
    l.DeviceSerial,
    substr(a.fta_code,5,4) as prin,    
    b.leakid lid2, 
    b.address_line1 address2, 
    m.DateTimeofRecord DateTimeofRecord2, 
    b.city city2, 
    m.uV_mLevel uV_mLevel2,
    b.repair_code repair_code2, 
    b.repair_date repair_date2,
    b.repair_time repair_time2,
    b.tech tech2, 
    b.wt_job wt_job2, 
    b.ordid ordid2,
    b.jobid jobid2,
    m.Status Status2,
    b.job_status job_status2,
    b.node_name node_name2,
    b.mgmt_area mgmt_area2,
    m.DeviceSerial DeviceSerial2,
    substr(b.fta_code,5,4) as prin2,    
    c.desc as CompanyName     
FROM leaks.accts_to_SRO a
INNER JOIN leaks.accts_to_SRO b ON a.acct = b.acct 
    AND a.acct != '' AND b.acct != '' AND a.leakid != b.leakid
INNER JOIN leaks.leaks l ON a.leakid = l.id AND l.DateTimeofRecord >= (NOW() - INTERVAL ? DAY) 
INNER JOIN leaks.leaks m ON b.leakid = m.id AND m.DateTimeofRecord >= (NOW() - INTERVAL ? DAY) 
LEFT JOIN locations c ON c.id = l.locationId

WHERE 1=1    
AND (l.peakid != m.peakid OR l.peakid = '' OR l.peakid IS NULL OR l.peakid = 0)
$strWhere";

// Prepare statement to prevent SQL injection
try {
    $dbConnection = CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn();    
    $stmt = mysqli_prepare($dbConnection, $query);    
    if (!$stmt) {
        throw new Exception("Failed to prepare statement: " . mysqli_error($dbConnection));
    }
    
    // Bind parameters
    $params = [$showLast, $showLast];

    // Then add location parameters if any
    if (!empty($locations)) {
        $params = array_merge($params, $locations);
    }
    
    // Create type string for bind_param (all integers except for the first two which are also integers)
    $types = str_repeat('i', count($params));
    
    // Bind parameters dynamically
    mysqli_stmt_bind_param($stmt, $types, ...$params);
    
    // Execute the statement
    if (!mysqli_stmt_execute($stmt)) {
        throw new Exception("Failed to execute statement: " . mysqli_stmt_error($stmt));
    }
    
    $results = mysqli_stmt_get_result($stmt);
    
} catch (Exception $e) {
    error_log("Database error: " . $e->getMessage());
    die("An error occurred while processing your request.");
}

// Set headers for CSV download
header('Content-Type: text/csv; charset=utf-8');
header('Content-Disposition: attachment; filename=LeakData_Repeats.csv');

// Create file pointer
$output = fopen('php://output', 'w');

// Write CSV header
fputcsv($output, [
    'wt_job',
    'id',
    'Address',
    'uV_mLevel',
    'Status',
    'SRO_Status',
    'DateTimeofRecord',
    'jobid',
    'acct',
    'prin',
    'city',
    'node',
    'ma',
    'DeviceSerial',
    'repair_code',
    'repair_date',
    'tech',
    'CompanyName',
    'WorkOrder'
]);

// Process results
$i = 0;
$prevAcct = '';
while ($row = mysqli_fetch_assoc($results)) {
    $i++;
    
    // Sanitize account field to prevent CSV injection
    $fields_to_escape = ['acct'];
    foreach ($fields_to_escape as $field) {
        if (isset($row[$field])) {
            // Add apostrophe to prevent formula injection
            $row[$field] = "\t" . $row[$field]; // Prefix with tab
        }
    }

    // Only write first record if it's a new account
    if ($prevAcct != $row['acct']) {
        fputcsv($output, [
            $row['wt_job'],
            $row['lid'],
            $row['address'],
            $row['uV_mLevel'],
            $row['Status'],
            $row['job_status'],
            $row['DateTimeofRecord'],
            $row['jobid'],
            $row['acct'],
            $row['prin'],
            $row['city'],
            $row['node_name'],
            $row['mgmt_area'],
            $row['DeviceSerial'],
            $row['repair_code'],
            $row['repair_date'] . " " . $row['repair_time'],
            $row['tech'],
            $row['CompanyName'],
            "\t" . $row['ordid'] // Prefix with tab to prevent formula injection
        ]);
        $prevAcct = $row['acct'];
    }
    
    // Write second record
    fputcsv($output, [
        $row['wt_job2'],
        $row['lid2'],
        $row['address2'], // Use address2 for second record
        $row['uV_mLevel2'],
        $row['Status2'],
        $row['job_status2'],
        $row['DateTimeofRecord2'],
        $row['jobid2'],
        $row['acct'],
        $row['prin2'],
        $row['city2'], // Use city2 for second record
        $row['node_name2'],
        $row['mgmt_area2'],
        $row['DeviceSerial2'],
        $row['repair_code2'],
        $row['repair_date2'] . " " . $row['repair_time2'],
        $row['tech2'],
        $row['CompanyName'],
        "\t" . $row['ordid2'] // Prefix with tab to prevent formula injection
    ]);
}

// Close file pointer
fclose($output);

// Mark download as complete
setCookie("downloadStarted", 0, time() + 20, '/', "", false, false);

// Exit if no rows were processed
if ($i == 0) {
    exit;
}
?>
