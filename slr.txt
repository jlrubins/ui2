<?php

    require('header.php');
    use \LeaksApp\CoreHandler;
    if (isset($_POST["status"])) {
        $status = filter_var($_POST["status"], FILTER_SANITIZE_STRING);
        $level = filter_var($_POST["level"], FILTER_SANITIZE_NUMBER_INT);
        $frequency = filter_var($_POST["freq"], FILTER_SANITIZE_STRING);
        $array_UniqueID = [];
        if ($status === 'C') {
            $repaired = filter_var($_POST["repaired"], FILTER_SANITIZE_STRING);
            $ProblemFoundCode = filter_var($_POST["resolution"], FILTER_SANITIZE_STRING);
        } else {
            $repaired = null;
            $ProblemFoundCode = null;
        }
        /*=================================Frequency/Level Check Start===========================================*/
        if (is_numeric($frequency)) {
            if ($frequency >= 0 && $frequency <= 299) {
                $freqCol = 'lowFreq';
                $freqVal = $frequency;
                $levelCol = 'lowLevel';
                $levelVal = $level;
            } elseif ($frequency >= 300 && $frequency <= 499) {
                $freqCol = 'midFreq';
                $freqVal = $frequency;
                $levelCol = 'midLevel';
                $levelVal = $level;
            } else {
                $freqCol = 'highFreq';
                $freqVal = $frequency;
                $levelCol = 'highLevel';
                $levelVal = $level;
            }
        }
        /*======================================================================================================*/
        $sql = "SELECT MAX(UniqueID)+1 as UniqueIDcount FROM leaks WHERE source = 'manual'";
        $conn = CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn();
        $result = mysqli_query($conn, $sql) or die(
            'Query failed: ' . mysqli_error($conn)
        );
        while ($row = mysqli_fetch_assoc($result)) {
            $array_UniqueID[] = $row['UniqueIDcount'];
        }
        if (empty(array_filter($array_UniqueID))) {
            $array_UniqueID[0] = 1;
        }
        
        // Use prepared statement to prevent SQL injection
        $query = "INSERT INTO `leaks`.`leaks` 
                    (`UniqueID`,
                    `DateTimeofRecord`,
                    `last_new_reading`,
                    `Location`,
                    `Latitude`,
                    `Longitude`,
                    `Address`,
                    `zip`,
                    `uV_mLevel`,
                    `Status`,
                    `ProblemFoundCode`,
                    `Comments`,
                    `DateofRepair`,
                    `TechID`,
                    `insertDate`,
                    `source`,
                    `locationId`,
                    `$levelCol`,
                    `$freqCol`)
                    VALUES
                    (?, ?, ?, 'Manual', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, sysdate(), 'manual', ?, ?, ?)";
        
        $stmt = mysqli_prepare($conn, $query);
        if ($stmt) {
            // Sanitize all inputs
            $uniqueID = filter_var($array_UniqueID[0], FILTER_SANITIZE_NUMBER_INT);
            $detected = filter_var($_POST['detected'], FILTER_SANITIZE_STRING);
            $lat = filter_var($_POST['lat'], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
            $lng = filter_var($_POST['lng'], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
            $address = filter_var($_POST['address'] . " " . $_POST['city'] . "," . $_POST['state'], FILTER_SANITIZE_STRING);
            $zip = filter_var($_POST['zip'], FILTER_SANITIZE_NUMBER_INT);
            $uvLevel = filter_var($_POST['level'], FILTER_SANITIZE_NUMBER_INT);
            $statusSanitized = filter_var($_POST['status'], FILTER_SANITIZE_STRING);
            $comments = filter_var($_POST['comments'], FILTER_SANITIZE_STRING);
            $tech = filter_var($_POST['tech'], FILTER_SANITIZE_STRING);
            $locationId = filter_var($_POST['areaid'], FILTER_SANITIZE_NUMBER_INT);
            
            mysqli_stmt_bind_param($stmt, "issssssssssssssss", 
                $uniqueID,
                $detected,
                $detected,
                $lat,
                $lng,
                $address,
                $zip,
                $uvLevel,
                $statusSanitized,
                $ProblemFoundCode,
                $comments,
                $repaired,
                $tech,
                $locationId,
                $levelVal,
                $freqVal
            );
            
            $results = mysqli_stmt_execute($stmt);
            if (!$results) {
                die("Invalid Query: " . mysqli_error($conn));
            } else {
                echo "<h3>Congratulations, you have just submitted a new leak. Please click here to see the <a href=details.php?id=" . mysqli_insert_id($conn) . ">details</a></h3>";
            }
            mysqli_stmt_close($stmt);
        } else {
            die("Prepared statement failed: " . mysqli_error($conn));
        }
    }
    echo '<h2>Add Leak</h2>
            <blockquote>
            <p>To create a NWT JB or an SRO for an open pending leak that needs to be repaired, please select Open.</p>
            <p>For leaks that are already repaired and are being entered for reporting purposes only, please select Closed.</p>
            </blockquote>
            <form id="newLeakForm" class="form-horizontal" method="post">
              <div class="form-group">
                <label for="status" class="col-sm-2 control-label">Status</label>
                <div class="col-sm-5">
                <select id="status" name="status" class="form-control validate[required] " style= "width: 100%">
                <option></option>
                <option value="O">Open</option>
                <option value="C">Close</option>
                </select>
                </div>
              </div>
              <div class="form-group">
                <label for="address" class="col-sm-2 control-label">Address</label>
                <div class="col-sm-5">
                    <input id="address" name="address" class="form-control validate[required]" placeholder="Address">
                </div>
              </div>
              <div class="form-group">
                <label for="city" class="col-sm-2 control-label">City</label>
                <div class="col-sm-5">
                    <input class="form-control validate[required]" id="city" name="city" placeholder="city">
                </div>
              </div>
              <div class="form-group">
                <label for="state" class="col-sm-2 control-label">State</label>
                <div class="col-sm-5">
                    <input class="form-control validate[required]" id="state" name="state" placeholder="State" maxlength="2">
                </div>
              </div>
              <div class="form-group">
                <label for="zip" class="col-sm-2 control-label">Zip</label>
                <div class="col-sm-5">
                    <input class="form-control validate[required ,custom[onlyNumberSp]] " id="zip" name="zip" placeholder="Zip">
                </div>
              </div>
    ';

    $conn = CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn();
    $query = "SELECT o.sourceId, o.desc, o.id
                FROM leaks.locations o
                WHERE o.`active` = 1
                GROUP BY sourceId, o.desc
                ORDER BY o.desc";
    $results = mysqli_query($conn, $query) or print_r(
        'Query Error ' . mysqli_error($conn)
    );
    //display all the areas
    echo '<div class="form-group">
            <label for="areaid" class="col-sm-2 control-label">Area</label>
            <div class="col-sm-5">
            <select class="span3 form-control validate[required]" id="areaid" name="areaid" style= "width: 100%">';
    $list = null;
    $list[] = "<option value=>Select an area</option>";
    while ($row = mysqli_fetch_array($results)) {
         $list[] = "<option value=" . filter_var($row['id'], FILTER_SANITIZE_NUMBER_INT) . ">" . filter_var($row['desc'], FILTER_SANITIZE_STRING) . " (" . filter_var($row['id'],
                        FILTER_SANITIZE_NUMBER_INT) . ")</option>";
    }
    echo implode("", $list);
    echo "</select></div></div>";
    echo '
          <div class="form-group">
            <label for="lat" class="col-sm-2 control-label">Lat</label>
            <div class="col-sm-5">
            <input class="form-control " id="lat" name="lat" placeholder="Lat">
            </div>
          </div>
          <div class="form-group">
            <label for="lng" class="col-sm-2 control-label">Long</label>
            <div class="col-sm-5">
            <input class="form-control " id="lng" name="lng" placeholder="Long">
            </div>
          </div>
          <div class="form-group">
            <label for="detected" class="col-sm-2 control-label">Date Detected</label>
            <div class="col-sm-5">
                <input type="text" id="detected" name="detected" value="' . date('Y-m-d') . '" class="form-control validate[required]" maxsize="10">
            </div>
          </div>
          <div class="form-group" id="dtRepaired">
            <label for="repaired" class="col-sm-2 control-label">Date Repaired</label>
            <div class="col-sm-5">
                <input type="text" id="repaired" name="repaired" value="' . date('Y-m-d') . '" class="form-control validate[required]" maxsize="10">
            </div>
          </div>
          <div class="form-group">
            <label for="level" class="col-sm-2 control-label">Level</label>
            <div class="col-sm-5">
            <input class="form-control validate[required ,custom[onlyNumberSp]] " id="level" name="level" placeholder="Level">
            </div>
          </div>
          <div class="form-group">
            <label for="freq" class="col-sm-2 control-label">Frequency</label>
            <div class="col-sm-5">
            <input class="form-control validate[required ,custom[onlyNumberSp]] " id="freq" name="freq" placeholder="Frequency">
            </div>
          </div>
          <div class="form-group">
            <label for="tech" class="col-sm-2 control-label">Repair Employee</label>
            <div class="col-sm-5">
            <input class="form-control validate[required]" id="tech" name="tech" placeholder="Repair Employee" value="' . filter_var($_SESSION['XOC']['USERNAME'], FILTER_SANITIZE_STRING) . '">
            </div>
          </div>
          <div class="form-group" id="idResolution">
            <label for="resolution" class="col-sm-2 control-label">Resolution</label>
            <div class="col-sm-5">
                <select id="resolution" name="resolution" class="form-control validate[required]" style= "width: 100%">
                    <option></option>
                    <option value="Aerial cable repaired">Aerial cable repaired</option>
                    <option value="Customer premise – undetermined">Customer premise – undetermined</option>
                    <option value="Drop disconnected">Drop disconnected</option>
                    <option value="Drop repaired">Drop repaired</option>
                    <option value="Inside wiring repaired">Inside wiring repaired</option>
                    <option value="Other – leak repaired">Other – leak repaired</option>
                    <option value="Outside connector repaired">Outside connector repaired</option>
                    <option value="Underground cable repaired">Underground cable repaired</option>
                </select>
            </div>
          </div>
          <div class="form-group">
            <label for="comments" class="col-sm-2 control-label">Comments</label>
            <div class="col-sm-5">
            <textarea id="address" name="comments" id=comments class="form-control"></textarea>
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" id=submitBtn class="btn btn-default">Add Leak</button>
            </div>
          </div>
        </form>
    ';
    include('footer.php');
?>
<link rel="stylesheet" href="/CSS/jquery.validationEngine___latest.css"/>
<script src="/JS/jquery.validationEngine-en___latest.js" charset="utf-8"></script>
<script src="/JS/jquery.validationEngine___latest.js" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/js/select2.min.js"></script>
<script>
    $("#detected").datepicker({
        dateFormat: 'yy-mm-dd'
    });
    $("#repaired").datepicker({
        dateFormat: 'yy-mm-dd'
    });
    $(document).ready(function () {
        //get tabs working
        $('#submitBtn').click(function (e) {
            e.preventDefault()
            if ($("#newLeakForm").validationEngine('validate')) {
                $("form").submit();
            }
            //$("#newLeakForm").submit();
        });
        /*=====================================SELECT2 INITIALIZE==============================================================*/
        $('select').select2();
        /*=====================================SELECT2 END=====================================================================*/
        /*=====================================STATUS ONCHANGE START===========================================================*/
        $("#dtRepaired").hide();
        $("#idResolution").hide();
        $("#status").on('change', function () {
            var statusSelected = $(this).val();
            console.log(statusSelected); // or $(this).val()
            if (statusSelected != '' && statusSelected == 'C') {
                $("#dtRepaired").show('slow');
                $("#idResolution").show('slow');
            }
            if (statusSelected != '' && statusSelected == 'O') {
                $("#dtRepaired").hide('slow');
                $("#idResolution").hide('slow');
                $("#repaired").val('');
                $("#resolution").val('');
            }
        });
        /*=====================================STATUS ONCHANGE End============================================================*/
    });
</script>
