<?php

    // Status should be 'O'

    require('header.php');

    use \LeaksApp\CoreHandler;

    if (isset($_POST["frmSubmitted"])) {
        $level = filter_var($_POST["level"], FILTER_SANITIZE_NUMBER_INT);
        $array_UniqueID = [];
        $repaired = null;
        $ProblemFoundCode = null;
        $freqCol = 'lowFreq';
        $freqVal = 141;
        $levelCol = 'lowLevel';
        $levelVal = $level;

        $sql = "SELECT MAX(UniqueID)+1 as UniqueIDcount FROM leaks WHERE source = 'cli_flyover'";
        $stmt = mysqli_prepare(CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn(), $sql);
        if ($stmt) {
            mysqli_stmt_execute($stmt);
            $result = mysqli_stmt_get_result($stmt);
            while ($row = mysqli_fetch_assoc($result)) {
                $array_UniqueID[] = $row['UniqueIDcount'];
            }
            mysqli_stmt_close($stmt);
        }
        
        if (empty(array_filter($array_UniqueID))) {
            $array_UniqueID[0] = 1;
        }

        $TECHID = filter_var($_SESSION['XOC']['USERNAME'], FILTER_SANITIZE_STRING);
        $locationId = 36511; // Freedom (Arcom) -- choose a random  NED region so it will match ticketing threshold settings
        $query = "INSERT INTO `leaks`.`leaks` 
												(`UniqueID`,
												`DateTimeofRecord`,
												`Latitude`,
												`Longitude`,
												`uV_mLevel`,
												`Status`,
												`ProblemFoundCode`,
												`Comments`,
												`DateofRepair`,
												`TechID`,
												`insertDate`,
												`source`,
												`locationId`,
												`$levelCol`,
												`$freqCol`)
												VALUES
												(?, ?, ?, ?, ?, 'O', ?, ?, ?, ?, sysdate(), 'cli_flyover', ?, ?, ?)";

        $conn = CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn();
        $stmt = mysqli_prepare($conn, $query);
        
        if ($stmt) {
            // Sanitize all input values
            $uniqueId = filter_var($array_UniqueID[0], FILTER_SANITIZE_NUMBER_INT);
            $dateTimeOfRecord = filter_var($_POST['detected'], FILTER_SANITIZE_STRING);
            $latitude = filter_var($_POST['lat'], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
            $longitude = filter_var($_POST['lng'], FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION);
            $uvLevel = filter_var($_POST['level'], FILTER_SANITIZE_NUMBER_INT);
            $comments = filter_var($_POST['comments'], FILTER_SANITIZE_STRING);
            $repairedValue = $repaired;
            $techId = $TECHID;
            $locationIdValue = $locationId;
            $levelValValue = $levelVal;
            $freqValValue = $freqVal;
            
            mysqli_stmt_bind_param($stmt, "issssissssssii", 
                $uniqueId,
                $dateTimeOfRecord,
                $latitude,
                $longitude,
                $uvLevel,
                $ProblemFoundCode,
                $comments,
                $repairedValue,
                $techId,
                $locationIdValue,
                $levelValValue,
                $freqValValue
            );
            
            $results = mysqli_stmt_execute($stmt);
            $insertId = mysqli_insert_id($conn);
            mysqli_stmt_close($stmt);
            
            if (!$results) {
                die("Invalid Query: " . mysqli_error($conn));
            } else {
                echo "<h3>Congratulations, you have just submitted a new leak. Please click here to see the <a href=details.php?id=" . $insertId . ">details</a></h3>";
            }
        } else {
            die("Prepare failed: " . mysqli_error($conn));
        }
    }

    echo '<h2>Add Leak from CLI Flyover</h2>
            <blockquote>
            <p>This form will create an open pending leak that needs to be repaired.  </p>
            <p>If the leak qualifies for ticketing, it will be processed shortly after by NWT JB or an SRO.</p>
            </blockquote>';
    echo '<form id="newLeakForm" class="form-horizontal" method="post" action="new_leak_cli_flyover.php">';

    $query = "SELECT o.sourceId, o.desc, o.id
    FROM leaks.locations o
    WHERE o.`active` = 1
    GROUP BY sourceId, o.desc
    ORDER BY o.desc";

    $results = mysqli_query(CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn(), $query) or print_r(
        'Query Error ' . mysqli_error(CoreHandler::instance()->database(CONN_ID_LEAKS_GENERAL_APP)->getConn())
    );

    echo '
    <div class="form-group">
        <label for="lat" class="col-sm-2 control-label">Lat</label>
        <div class="col-sm-5">
        <input class="form-control " id="lat" name="lat" placeholder="Lat">
        </div>
    </div>';

    echo '
  <div class="form-group">
    <label for="lng" class="col-sm-2 control-label">Long</label>
	<div class="col-sm-5">
    <input class="form-control " id="lng" name="lng" placeholder="Long">
	</div>
  </div>';


    echo '
  <div class="form-group">
    <label for="level" class="col-sm-2 control-label">Aeronautical Level</label>
	<div class="col-sm-5">
    <input class="form-control validate[required ,custom[onlyNumberSp]] " id="level" name="level" value="100" />
	</div>
  </div>';


    echo '
  <div class="form-group">
    <label for="detected" class="col-sm-2 control-label">Date Detected</label>
	<div class="col-sm-5">
		<input type=text id="detected" name="detected" value="' . date('Y-m-d') . '" class="form-control validate[required]" maxsize="10">
	</div>
  </div>
  ';


    echo '
  <div class="form-group">
    <label for="comments" class="col-sm-2 control-label">Comments</label>
	<div class="col-sm-5">
    <textarea id="address" name="comments" id=comments class="form-control"></textarea>
	</div>
  </div>';

    echo '<div class="form-group">
<div class="col-sm-offset-2 col-sm-10">
<input type="hidden" name="frmSubmitted" value="1" />
<button type="submit" id=submitBtn class="btn btn-default">Add Leak</button>
</div></div>
</form>
';

    include('footer.php');

?>
<link rel="stylesheet" href="/CSS/jquery.validationEngine___latest.css"/>
<script src="/JS/jquery.validationEngine-en___latest.js" charset="utf-8"></script>
<script src="/JS/jquery.validationEngine___latest.js" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/js/select2.min.js"></script>
<script>

    $("#detected").datepicker({
        dateFormat: 'yy-mm-dd'
    });

    $(document).ready(function () {        
        $('#submitBtn').click(function (e) {
            e.preventDefault()
            if ($("#newLeakForm").validationEngine('validate')) {                
                $("form").submit();
            }
        });
        $('select').select2();
        $("#status").on('change', function () {
            var statusSelected = $(this).val();
            console.log(statusSelected);
        });
    });
</script>
